# File: .github/workflows/build.yml
# This workflow uses a Docker container to ensure a consistent and reproducible build environment.

name: Docker-based ESP32 Build

# Trigger the workflow on every push to any branch.
on:
  push:
    branches: [ '*' ]

# Cancel in-progress runs for the same branch on a new push.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-with-docker:
    name: Build Project (Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build \
            --build-arg SOURCE_REPO_URL="https://github.com/${{ github.repository }}.git" \
            --build-arg SKETCH_NAME="ESP32_FC" \
            -t esp32-builder .

  # This optional job provides a clean summary of the build result.
  # It runs after the build job, regardless of whether it succeeded or failed.
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    if: always()
    needs: build-with-docker
      
    steps:
      - name: Create Build Summary
        run: |
          echo "# 🔧 ESP32 Docker Build Report" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build-with-docker.result }}" == "success" ]]; then
            echo "| 🔨 Docker Build & Compile | ✅ Passed | The project was successfully compiled in the defined Docker environment. |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 🔨 Docker Build & Compile | ❌ Failed | The Docker build failed. Check the logs of the 'Build Project (Docker)' job for details. |" >> $GITHUB_STEP_SUMMARY
          fi
          